<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Proxanon</title>
</head>

<body>
  <div id="app">
    <button>Get your location geohash</button>
    <p></p>
    <ul></ul>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const text = document.querySelector("p");
    const btn = document.querySelector("button");
    const ul = document.querySelector('ul');

    let user = JSON.parse(localStorage.getItem("user") || "{}");

    if (user?.hash) {
      text.innerHTML = `Your geohash is ${user.hash}`;
      btn.disabled = true;
      btn.innerText = "You are already signed in";
    }

    const displayUserInfo =
      (hash, username) => {
        if (hash && username) {
          text.innerHTML = `Your geohash is ${hash} and your username is ${username}`;
        }
      }

    displayUserInfo(user?.hash, user?.username)


    const socket = io({
      query: {
        hash: user?.hash,
        username: user?.username,
      }
    });

    // Listen for the signin event from the server and display the user hash
    socket.on("signin", (data) => {
      const { hash, username } = data;

      displayUserInfo(hash, username)

      // Save the user hash in the local storage so that the user doesn't have to sign in again
      localStorage.setItem("user", JSON.stringify({
        hash,
        username,
      }));

      user = { hash, username };
    })

    socket.on("users", (users) => {
      const mapUsersToLi = users.map((user) => {
        return `<li>${user.username} is at ${user.hash}</li>`;
      });

      ul.innerHTML = mapUsersToLi.join("");
    })

    btn.addEventListener("click", () => {
      if (user?.hash) return

      navigator.geolocation.getCurrentPosition((position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        // Signin the user by emitting the signin event to the server with the user's location data (lat, lon)
        socket.emit("signin", {
          lat,
          lon,
        })
      });
    });
  </script>
</body>

</html>